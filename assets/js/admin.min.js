function waymark_setup_map_export(){jQuery(".waymark-map-export").each((function(){var a=jQuery(this),e=a.parents(".waymark-meta-export_data");if(waymark_is_touch_device())e.hide();else if(a){var t=jQuery("a",a),r=jQuery("select",a);"undefined"!=typeof Waymark&&Waymark.map.on("layerremove layeradd",(function(){var a=0;Waymark.map_data.eachLayer((function(e){Waymark.map.hasLayer(e)&&a++})),a>0?e.show():e.hide()})),t.on("click",(function(e){var t=r.val()?r.val():"geojson",o=Waymark_L.layerGroup();Waymark.map_data.eachLayer((function(a){if(Waymark.map.hasLayer(a)){for(key in a.feature.properties)void 0!==a.feature.properties[key]?"title"==key&&"kml"==t&&(a.feature.properties.name=a.feature.properties[key],delete a.feature.properties[key]):delete a.feature.properties[key];o.addLayer(a)}}));var n=o.toGeoJSON();switch(r.val()){case"gpx":var i=togpx(n),u="application/gpx+xml;charset=utf-8,"+encodeURIComponent(i),s="gpx";break;case"kml":var c=tokml(n);u="application/vnd.google-earth.kml+xml;charset=utf-8,"+encodeURIComponent(c),s="kml";break;default:case"geojson":u="application/geo+json;charset=utf-8,"+encodeURIComponent(JSON.stringify(n)),s="geojson"}jQuery(this).attr({href:"data:"+u,download:a.data("map_slug")+"-"+a.data("map_id")+"."+s})}))}}))}function waymark_setup_parameter_tooltips(){jQuery("a.waymark-tooltip").on({mouseenter:function(a){var e=jQuery(this).data("title");jQuery('<p id="waymark-tooltip-active"></p>').text(e).appendTo("body").fadeIn("slow")},mouseleave:function(a){jQuery("#waymark-tooltip-active").remove()},mousemove:function(a){if(waymark_is_touch_device())var e=a.pageX-250;else e=a.pageX-220;var t=a.pageY+5;jQuery("#waymark-tooltip-active").css({top:t,left:e})}})}function waymark_is_touch_device(){var a=" -webkit- -moz- -o- -ms- ".split(" ");return!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)||function(a){return window.matchMedia(a).matches}(["(",a.join("touch-enabled),("),"heartz",")"].join(""))}function waymark_setup_accordions(){var a=jQuery(".waymark-accordion-container");a.length&&(a.addClass("waymark-self-clear"),a.each((function(){var a=0;jQuery(".waymark-accordion-group",jQuery(this)).each((function(){jQuery(this).addClass("waymark-self-clear"),jQuery(this).data("waymark-index",a);var e=jQuery(".waymark-accordion-group-content",jQuery(this));0==a?(jQuery(this).addClass("waymark-first"),e.show().addClass(a)):e.hide().addClass(a),jQuery("legend",jQuery(this)).each((function(){var a=jQuery(this).html();-1==a.indexOf("[+]")&&jQuery(this).html(a+" <span>[+]</span>"),jQuery(this).click((function(){var a=jQuery(this).parents(".waymark-accordion-group").data("waymark-index");jQuery(".waymark-accordion-group",jQuery(this).parents(".waymark-accordion-container")).each((function(){jQuery(this).data("waymark-index")==a?jQuery(".waymark-accordion-group-content",jQuery(this)).slideDown():jQuery(".waymark-accordion-group-content",jQuery(this)).slideUp()}))}))})),a++}))})))}function waymark_setup_colour_pickers(){jQuery(".waymark-colour-picker .waymark-input").wpColorPicker()}function waymark_setup_repeatable_sections(){jQuery(".waymark-settings-tab .waymark-repeatable").each((function(){var a=jQuery(this);jQuery(".form-table",a).each((function(){var e=jQuery(this),t=[];for(e.remove(),jQuery(".waymark-input",e).each((function(){var a=jQuery(this);if(a.addClass("waymark-"+a.attr("id")),"SELECT"!=a.get(0).nodeName)var e=a.val();else e=a.data("multi-value");for(i in"string"!=typeof e&&(e=e.toString()),console.log(typeof e),e=e.split(waymark_multi_value_seperator))"object"!=typeof t[i]&&(t[i]={}),t[i][a.attr("id")]=e[i]})),i=0;i<t.length;i++){var r=e.clone();for(j in t[i]){var o=t[i][j],n=jQuery("#"+j,r);n.attr("name",n.attr("name")+"["+i+"]"),"SELECT"!=n.get(0).nodeName||jQuery("option[value='"+t[i][j]+"']",n).length||(o=jQuery("option",n).first().val()),n.attr("value",o).val(o),n.parents(".waymark-control-group").hasClass("waymark-uneditable")&&n.attr("readonly","readonly")}var u=jQuery("<div />").text("x").attr("title",waymark_php_lang.repeatable_delete_title).addClass("waymark-delete").on("click",(function(a){return a.preventDefault(),jQuery(this).parents(".form-table").remove(),!1}));r.append(u),a.append(r),a.attr("data-count",i),waymark_setup_parameter_tooltips()}var s=jQuery("<button />").html('<i class="ion ion-plus"></i>').addClass("button waymark-add").on("click",(function(a){a.preventDefault();var t=jQuery(this).parents(".waymark-repeatable"),r=parseInt(t.attr("data-count"))+1;t.attr("data-count",r);var o=e.clone();return jQuery(".waymark-input",o).each((function(){var a=jQuery(this),e=a.attr("name")+"["+r+"]";switch(a.attr("name",e),a.attr("placeholder",""),"SELECT"!=a.get(0).nodeName&&a.val(""),a.attr("id")){case"line_colour":case"shape_colour":case"icon_colour":a.wpColorPicker();break;case"marker_colour":waymark_setup_marker_colour_input(a);break;case"meta_options":a.parents("tr").hide()}})),jQuery(this).before(o),waymark_setup_parameter_tooltips(),waymark_setup_select_meta_type(),!1}));a.append(s),a.sortable()}))}))}function waymark_setup_marker_tab(){jQuery(".waymark-input.waymark-marker_icon").each((function(){var a=jQuery(this),e=jQuery("<i />").addClass("ion "+a.val());a.parents(".waymark-controls").prepend(e)})),jQuery(".waymark-input.waymark-marker_colour").each((function(){waymark_setup_marker_colour_input(jQuery(this))}))}function waymark_setup_marker_colour_input(a){var e=["red","darkred","orange","green","darkgreen","blue","purple","darkpurple","cadetblue","white","black"],t=jQuery("<div />").addClass("waymark-swatch-container waymark-self-clear");for(i in e){var r=e[i],o=jQuery("<div />").addClass("waymark-swatch waymark-swatch-"+r).attr({"data-value":r,title:r}).text(" ").on("click",{input:a},(function(e){var r=jQuery(this);jQuery(".waymark-swatch",t).each((function(){jQuery(this).removeClass("waymark-selected")})),a.val(r.data("value")),r.addClass("waymark-selected")}));r==a.val()&&o.addClass("waymark-selected"),t.append(o)}a.parents(".waymark-controls").append(t)}function waymark_setup_external_links(){jQuery(".waymark-settings-tab a,#waymark_map_meta a").each((function(){location.hostname!==this.hostname&&this.hostname.length&&void 0===jQuery(this).attr("target")&&jQuery(this).attr("target","_blank")}))}function waymark_setup_select_meta_type(){jQuery("select.waymark-meta_type").each((function(){var a=jQuery(this),e=a.parents(".form-table"),t=jQuery(".waymark-input.waymark-meta_options",e).parents("tr");"select"==a.val()||"select_multi"==a.val()?t.show():t.hide(),a.change((function(){"select"==a.val()||"select_multi"==a.val()?t.show():t.hide()}))}))}jQuery(document).ready((function(){waymark_setup_parameter_tooltips(),waymark_setup_map_export(),waymark_setup_accordions()})),jQuery(document).ready((function(){waymark_setup_repeatable_sections(),waymark_setup_colour_pickers(),waymark_setup_marker_tab(),waymark_setup_external_links(),waymark_setup_select_meta_type()}));